<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerenciar Dados com Gráfico</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <style>
    canvas {
      max-width: 400px;
      max-height: 300px;
    }
  </style>
</head>
<body>
  <h1>Gerenciar Dados com Gráfico</h1>
  <p><strong>Diferença entre a soma dos valores:</strong> <span id="sumDifference">0</span></p>

  <button onclick="openModal('table1')">Adicionar Dados - Tabela 1</button>
  <button onclick="openModal('table2')">Adicionar Dados - Tabela 2</button>

  <div id="modal" style="display:none;">
    <h2 id="modalTitle">Adicionar Dados</h2>
    <label>ID: </label><input type="text" id="modalId"><br>
    <label>Valor: </label><input type="number" id="modalValue"><br>
    <button onclick="saveData()">Salvar</button>
    <button onclick="closeModal()">Cancelar</button>
  </div>

  <h2>Tabela 1</h2>
  <table id="table1">
    <thead>
      <tr><th>ID</th><th>Valor</th><th>Data</th><th>Ações</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <canvas id="chart1"></canvas>

  <h2>Tabela 2</h2>
  <table id="table2">
    <thead>
      <tr><th>ID</th><th>Valor</th><th>Data</th><th>Ações</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <canvas id="chart2"></canvas>

  <script>
    const socket = io();
    let currentTable;
    let charts = {};

    function openModal(table) {
      currentTable = table;
      document.getElementById('modal').style.display = 'block';
    }

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }

    function saveData() {
      const id = document.getElementById('modalId').value;
      const value = parseFloat(document.getElementById('modalValue').value);
      const date = new Date().toLocaleString();

      fetch(`/api/${currentTable}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id, value, date })
      }).then(() => closeModal());
    }

    function loadTable(table) {
      fetch(`/api/${table}`)
        .then(res => res.json())
        .then(data => {
          const tbody = document.querySelector(`#${table} tbody`);
          tbody.innerHTML = '';
          data.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${row.id}</td>
              <td>${row.value}</td>
              <td>${row.date}</td>
              <td><button onclick="deleteData('${table}', '${row.id}')">Apagar</button></td>`;
            tbody.appendChild(tr);
          });
          updateChart(table, data);
        });
    }

    function deleteData(table, id) {
      fetch(`/api/${table}?id=${id}`, { method: 'DELETE' });
    }

    function updateChart(table, data) {
      const chartId = table === 'table1' ? 'chart1' : 'chart2';
      const ctx = document.getElementById(chartId).getContext('2d');
      const chartData = data.map(row => row.value);
      const labels = data.map(row => row.id);

      if (charts[chartId]) charts[chartId].destroy();

      charts[chartId] = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{ data: chartData }]
        }
      });
    }

    socket.on('update_graph', (data) => {
      loadTable(data.table);
    });

    loadTable('table1');
    loadTable('table2');
  </script>
</body>
</html>
